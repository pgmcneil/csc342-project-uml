<!Doctype html>
<html>
<head>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
	<script src="raphael-min.js"></script>
	<script>
	
			function collapse(){
				var obj = (this === window) ? $(".selectedObject") : $(this);
				$(obj).find(".content").slideUp(function(){
					$(this).parent().find(".header").css("border-radius", "5px");
					$(this).parent().find(".minimize").html("&#9633;");
				});
				if(obj.attr("id") === $(".selectedObject").attr("id")){
					//Change button visibility
					$("#toggleMinimize").html('Expand');
				}
			}
			
			function expand(){
				var obj = (this === window) ? $(".selectedObject") : $(this);
				obj.find(".header").css("border-radius", "5px 5px 0 0");						
				obj.find(".content").slideDown(function(){
						$(this).parent().find(".minimize").html("_");
				});
				if(obj.attr("id") === $(".selectedObject").attr("id")){
					//Change button visibility
					$("#toggleMinimize").html('Collapse');
				}

			}
			
			function collapseAll() {
				$(".object").each(function() {
					collapse.call(this);
				});
			}			
			
			function expandAll() {
				$(".object").each(function() {
					expand.call(this);
				});
			}
	
			function toggleMinimize(){
				var obj = (this === window) ? $(".selectedObject") : $(this);
				if(obj.find(".content").is(":visible")){
					//alert("should collapse.");
					collapse.call(obj);
				}else{
					expand.call(obj);
				}

			
			}
		
			function rename() {
				$(".selectedObject .objectTitle").html(document.getElementById('rename_text').value);
			}
			
			function clearAll() {
				$(".object").remove();
			}
		Raphael.fn.arrow = function (x1, y1, x2, y2, size) {
			var angle = -90;
			var width = $(".object").width();
			var offset = 0;
			var target = 20;
			var arrowPath;
			var linePath;
			if ((Math.abs(x1 - x2)) < width) {
				angle = 90;
				offset = 40;
				x2 += 12;
				x1 += 12;
				linePath = this.path("M" + x1 + " " + y1 + " L" + (x1 + offset) + " " + y1 + " L" + (x1 + offset) + " " + y2 + " L" + x2 + " " + y2);
			} else	if (x1 < x2) {
				x2 -= width;
				x1 += 12;
				offset = Math.abs(x1 - x2) / 2;
				linePath = this.path("M" + x1 + " " + y1 + " L" + (x1 + offset) + " " + y1 + " L" + (x1 + offset) + " " + y2 + " L" + x2 + " " + y2);
			} else if (x2 < x1) {
				x1 -= width;
				offset = Math.abs(x1 - x2) / 2;
				x2 += 12;
				angle = 90;
				offset *= -1;
				linePath = this.path("M" + x1 + " " + y1 + " L" + (x1 + offset) + " " + y1 + " L" + (x1 + offset) + " " + y2 + " L" + x2 + " " + y2);
			}
			linePath.attr("stroke-width", 3).attr("arrow-end", "classic-wide-long");
			return linePath;
		};
		
		$(document).ready(function() {
			function objectTemplateWithID(id){
				return '<div class="object" id="object'+ id +'"> \
							<div class="header">	\
								<span class="objectTitle">Object ' + id + '</span> \
								<span class="minimize">_</span> \
								<span class="delete">X</span> \
							</div>	\
							<div class="content">	\
								<table> \
									<tr><td class="attribute">Sample attribute</td><td class="relation">o</td></tr> \
								</table> \
							</div>\
						</div>';
					
			};
			function createColorsMenu(id) {
				return '<div class="color-chooser" > \
					<div class="colors"> \
						<table> \
							<tr> \
								<td><div color="black" class="color" style="background-color: #00FF00"></div></td> \
								<td><div color="black" class="color" style="background-color: #FF7F00	"></div></td> \
								<td><div color="black" class="color" style="background-color: #FF0000"></div></td> \
							</tr> \
							<tr> \
								<td><div color="white" class="color" style="background-color: #0000CD"></div></td> \
								<td><div color="black" class="color" style="background-color: #70DB93"></div></td> \
								<td><div color="black" class="color" style="background-color: #CAFF70"></div></td> \
							</tr> \
							<tr> \
								<td><div color="black" class="color" style="background-color: #FFFF00"></div></td> \
								<td><div color="white" class="color" style="background-color: #236B8E"></div></td> \
								<td><div color="white" class="color" style="background-color: #236B8E"></div></td> \
							</tr> \
							<tr> \
								<td><div color="white" class="color" style="background-color: #006400"></div></td> \
								<td><div color="white" class="color" style="background-color: #800080"></div></td> \
								<td><div color="white" class="color" style="background-color: grey"></div></td> \
							</tr> \
						</table> \
           			</div> \
					<div class="prong"></div> \
					</div>';
			}
			function removeSettings() {
				$(".color-chooser").remove();
			}		
			
			function checkID(id) {
				if(document.getElementById("object"+id)) {
					return checkID(++id);
				} else {
					return id;
				}
			}
			
			function updateAttributesTable() {
				$("#objectAttributes .attributes").remove();
				$(".selectedObject .attribute").each(function() {					
					$("#objectAttributes").append('<tr class="attributes"><td>' + $(this).html() + '</td><td><input type="text" name="change_type" maxlength="10"></td><td><input type="text" name="change_comment" maxlength="10"></td>');
				});
			}
			
			function updateAttributesObject() {
				
			}
			
			function addAttribute() {
				$(".object.selectedObject .content tbody").append('<tr><td class="attribute"></td><td class="relation">o</td></tr>');
				editAttribute($(".object.selectedObject .content tbody tr:last td.attribute"));
			}
			function editAttribute(cell) {
			
				//Note: Setting the text after focusing
				//moves the cursor to the end of the string
				var curText = cell.html();
				cell.html('<input type="text"  />');
				cell.find("input").focus().val(curText).css("width", $(".object.selectedObject .content").width() - 20);
			}
			
			function recordAttribute(input) {
				input.parent().html(input.val());
				updateAttributesTable();
			}
			function removeAttribute(input) {
				input.parent().parent().remove();
				updateAttributesTable();
			}
			//hold value for zindex bring to front
			front = 0;
			isSelecting = false;
			relationSource = null;
			allRelationships = [];
			
			// Create the paper so that arrows can draw:
			var paper = new Raphael("canvas", 50, 50);
			function findMatchingRelations(object) {
				var matching = [];
				for(i = 0; i < allRelationships.length; i++) {
					relationshipObjectSource = allRelationships[i].source.closest(".object");
					relationshipObjectTarget = allRelationships[i].target.closest(".object");
					if (relationshipObjectSource.attr("id") == object.attr("id") || relationshipObjectTarget.attr("id") == object.attr("id")) {
						matching.push(allRelationships[i]);
					}
				}
				return matching;
			}
			
			function deleteRelation(object) {
				for(i = 0; i < allRelationships.length; i++) {
					relationshipObjectSource = allRelationships[i].source.closest(".object");
					relationshipObjectTarget = allRelationships[i].target.closest(".object");
					if (relationshipObjectSource.attr("id") == object.attr("id") || relationshipObjectTarget.attr("id") == object.attr("id")) {
						allRelationships[i].arrow.remove();
						allRelationships.splice(i--, 1);
					}
				}
			}
/*
 * LISTENERS
 * 
 */
			//Properties Listener
			$("#rename_text").change(function() {
				console.log("fired");
				$(".selectedObject .objectTitle").html($('#rename_text').val());
			});
			$("#rename_button").on("click", function(){
				$(".selectedObject .objectTitle").html(document.getElementById('rename_text').value);
				//alert(document.getElementById('rename_text').value);
			});
			$("#canvas").on("click", ".object .delete", function(e){
				$(this).parent().parent().remove();
				deleteRelation($(this).closest(".object"));
			});
			$("#canvas").on("click", ".object .minimize", function(e){
				toggleMinimize.call($(this).parent().parent());
				e.stopPropagation();
			});
			$("#canvas").on("mousedown", ".object .minimize", function(e){
				e.stopPropagation();
			});
			$("#canvas").on("mousedown", ".object .delete", function(e){
				e.stopPropagation();
			});
			$("#canvas").on("dblclick", ".object", function(e){
				e.stopImmediatePropagation();
				return true;					
			});
			$("#canvas").on("mousedown", ".object", function(e){
				removeSettings();
				updateAttributesTable();
				
				// //Bring to Front
				if($(this).css("z-index") != front){
					$(this).css("z-index", ++front);
				}
				//$("#zIndex").text( $(this).css("z-index")); //debug
				
				//Toggle Selected
				$(".selectedObject").removeClass("selectedObject");
				$(this).addClass("selectedObject");
				
				
				$('#rename_text').val($(this).find(".objectTitle").html());
				$('#selectedColor').css("background-color", $(this).find(".content").css("background-color"));
				
			}).on("mouseup", ".object", function(e) {
				findMatchingRelations($(this)).forEach(function(value, index, array) {
					value.arrow.remove();
					var relationArrow = paper.arrow(value.source.offset().left - 1, value.source.offset().top + 5, value.target.offset().left + 2, value.target.offset().top + 8, 8);
					value.arrow = relationArrow;
				});
			});
			
			//When the document is double clicked, spawn an object
			$("#canvas").on("dblclick", function(e) {
				
				//Position object so that the cursor is in the center of the header
				var id = 0;
				id = checkID(id);
				var newObject = objectTemplateWithID(id);
				$("#canvas").append(newObject);
				newObject = $("#object"+id);
				yPos = e.pageY - newObject.find(".header").height()/2;
				xPos = e.pageX - newObject.width()/2;
				
				
				//Add object and immediately select it
				newObject
					.offset({
						top: yPos,
						left: xPos
					})
					.draggable({containment: "parent"})
					.trigger("mousedown");
			});
			$("#toolbox").on("click", "#selectedColor", function(e) {
				e.stopPropagation();
				// if($(".settings-menu").length != 0) {
// 					return;
// 				}
				//var object = $(this).parent().parent();
				//alert($("selectedObject").attr("id"));
				var settings = createColorsMenu();
				$("#toolbox").append(settings);
				var xPos = $("#selectedColor").offset().left;
				var yPos = $("#selectedColor").offset().top + $("#selectedColor").height();
				// if(yPos < $(document).offset().top) {
// 					yPos = object.offset().top + object.height() + 20;
// 				}
				$(".color-chooser").offset({
					top: yPos,
					left: xPos
				});
			});
			$(document).on("click", function() {
				$(".color-chooser").remove();
			});
			$(document).on("click", ".color-chooser", function(e) {
				e.stopPropagation();
			});

			$(document).on("click", ".color", function(e){
				var color = $(this).css("background-color");
				$(".selectedObject .content").css("background-color", color);
				$(".selectedObject .content").css("color", $(this).attr("color"));
				$('#selectedColor').css("background-color", color);
				
			});
			$(document).on("click", ".object .content td.attribute", function(e) {
				e.stopPropagation();
				editAttribute($(this));
			});
			$(document).on("click", ".object .content td.relation", function(e) {
				e.stopPropagation();
				if(isSelecting && ($(this)[0] === relationSource[0])) {
					return;
				} else	if(isSelecting) {
					// connect the arrow here
					// relationSource.offset().top , relationSource.offset().left
					// to
					// $(this).offset().top , $(this).offset().left
					var relationArrow = paper.arrow(relationSource.offset().left - 1,relationSource.offset().top + 5, $(this).offset().left + 2, $(this).offset().top + 8, 8);
					allRelationships.push({source: relationSource, target: $(this), arrow: relationArrow});
					isSelecting = false;
					delete relationSource;
				} else {
					isSelecting = true;
					relationSource = $(this);
				}
			});
			$(document).on("click", ".object .content td input", function(e) {
				e.stopPropagation();
			});
			$(document).on("focusout", ".object .content input", function(e) {
				if($(this).val().length > 0) {
					recordAttribute($(this));
				} else {
					removeAttribute($(this));
				}
			});
			$(document).on("keypress", ".object .content input:focus", function(e) {
				if(e.which == 13) {
					addAttribute();
				}
			}).on("keydown", ".object .content input:focus", function(e) {
				if(e.which == 8 && $(this).val().length == 0) {
					e.preventDefault();
					var cells = $(".object.selectedObject .content tbody tr td.attribute:not(:has(input))");
					editAttribute($(cells[cells.length - 1]));
				}
			});
			$(document).on("click", ".object.selectedObject .content", function(e) {
				e.stopPropagation();
				addAttribute();
			});
			$(document).on("mousedown", ".object .content td", function(e) {
				e.stopPropagation();
			});
		});
	</script>


	<style>
	
		body,html{
  			height:98%;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
		div{
			display: inline-block;
			margin: -4px;
			vertical-align: top;
			
		}
		input {
			-webkit-touch-callout: default;
			-webkit-user-select: default;
			-khtml-user-select: default;
			-moz-user-select: default;
			-ms-user-select: default;
			user-select: default;
		}
		
		#canvas{
			height:100%;
			width: 85%;
			display: inline-block;
			border: 2px solid grey;
 			background-color:#fff;
			background-image: linear-gradient(rgba(0,0,0,.3) 2px, transparent 2px),
			linear-gradient(90deg, rgba(0,0,0,.3) 2px, transparent 2px),
 			linear-gradient(rgba(0,0,0,.3) 1px, transparent 1px),
			linear-gradient(90deg, rgba(0,0,0,.3) 1px, transparent 1px);
 			background-image: -webkit-linear-gradient(rgba(0,0,0,.3) 2px, transparent 2px),
   			-webkit-linear-gradient(left, rgba(0,0,0,.3) 2px, transparent 2px),
 			-webkit-linear-gradient(rgba(0,0,0,.3) 1px, transparent 1px),
			-webkit-linear-gradient(left, rgba(0,0,0,.3) 1px, transparent 1px);
			background-size:100px 100px, 100px 100px, 20px 20px, 20px 20px;
			background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px;
		}
		#canvas div {
			display: inline-block;	
		}
		
		.object {
			width: 120px;
			position: absolute;
			opacity: 0.8;
			border: 2px solid blue;	
			border-radius: 10px;

		}
		.object .header{
			color: white;
			position: relative;
			margin: 0px;
			border-top-left-radius:5px;
			border-top-right-radius:5px;
			top: 0px;
			opacity: 1;
			background:blue;
			height:25px;
			width:100%;	
		
		}
		.object .minimize {
			position: relative;
			left: 5%;
			top:15%;
			width: 15px;
			border-radius: 4px;
			text-align: center;
			color: white;
			cursor: pointer;
			float: left;
		}
		.object .minimize:hover{
			top: 10%;
			background: rgb(10,10,200);
		}
		.object .objectTitle{
			position: absolute;
			top: 15%;	
			left:30%;
		}
		.object .delete{
			position: relative;
			width: 16px;
			top: 15%;
			right:5%;
			float: right;
			text-align: center;
			cursor: pointer;
			border-radius: 4px;
		}
		.object .delete:hover{
			top: 10%;
			background: rgb(10,10,200);
		}
		.object .content {
			cursor: default;
			height: 150px;
			width: 100%;
			margin: 0px;
			border-radius: 0 0 7px 7px; 
			background-color: grey;
			color: white;
		}
		.object .content td.relation {
			text-align: right;
			width: 10px;
		}
		.object:hover {
			cursor: move;
		}
		.selectedObject{
			border: 2px solid red;	
			
		}
		.selectedObject .header{
			background: #f85032; /* Old browsers */
			background: -moz-linear-gradient(top, #f85032 0%, #f16f5c 50%, #f6290c 51%, #f02f17 71%, #FF0000 100%); /* FF3.6+ */
			background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#f85032), color-stop(50%,#f16f5c), color-stop(51%,#f6290c), color-stop(71%,#f02f17), color-stop(100%,#e73827)); /* Chrome,Safari4+ */
			background: -webkit-linear-gradient(top, #f85032 0%,#f16f5c 50%,#f6290c 51%,#f02f17 71%,#e73827 100%); /* Chrome10+,Safari5.1+ */
			
		}
		.selectedObject .delete:hover{
			top: 10%;
			background: rgb(200,10,10);

		}
		.selectedObject .minimize:hover{
			top: 10%;
			background: rgb(200,10,10);

		}
		
		#toolbox{
		 
			height:100%;
			width:14%;
			vertical-align: top;
			border: 2px solid black;
		    margin-left: 2px;
			display:inline-block;
		}
		#globalSettings{
			text-align: center;
		}
		#globalSettings button{
			width: 100px;
		}
		#selectedColor{
			position: relative;
			width: 20px;
			height: 20px;
			margin-left: 5px;
/* 			background: black; */
		}
		.color{		
			width: 20px;
			height: 20px;
			margin:left;
		}
		.color:hover{
		border: 1px solid #3399CC;
		
		
		}
		.color-chooser {
			width: 90px;
			height: 110px;
			background-color: #fff;
			border: 1px solid #ccc;	
			border-radius: 10px;
			-webkit-box-shadow: 0px 0px 8px rgba(0,0,0,0.3);
			-moz-box-shadow:    0px 0px 8px rgba(0,0,0,0.3);
			box-shadow:         0px 0px 8px rgba(0,0,0,0.3);
		}
		.color-chooser .colors {
 
			margin: 5px;
			margin-top:12px;
		}
		.colors td div{
			margin-left:4px;
		}
		#objectProperties{
			height:150px;
		}
		#rename_text{
			width:100%;
		}
		#rename_button {
			height: 10px;
			width: 10px;
			border: 1px solid black;
		}
		svg {
			height: 100%;
			width: 100%;
		}
	</style>
</head>

<body>
	
	<div id="canvas"></div>
	<div id="toolbox">
		<fieldset id="globalSettings">
			<legend>Global Settings:</legend>
				<button type="button" onclick= "clearAll()">Clear All</button><br/>
				<button type="button" onclick= "collapseAll()">Collapse All</button><br/>
				<button type="button" onclick= "expandAll()">Expand All</button>
		</fieldset>
		 
		<fieldset id="objectSettings">
			<legend> <img src="gearsettings.jpg" alt="gear for settings" width="42" height="42"> </legend>
			Color:
			<div id="selectedColor"></div>
			<br />			
			<button type="button" id="toggleMinimize" onclick="toggleMinimize()">Toggle!</button>
					
		</fieldset>
		
		<fieldset id="objectProperties">
			<legend>Properties:</legend>
			Name: <input id="rename_text" type="text" name="change_name" maxlength="10">
		</fieldset>
		
		<fieldset>
			<legend>Attributes:</legend>
			<table id="objectAttributes">
				<tr>
					<th>Attribute</th>
					<th>Type</th>
					<th>Comment</th>
				</tr>
			</table>
		</fieldset>
	
	</div>
	
	
	
	
</body>
</html>
